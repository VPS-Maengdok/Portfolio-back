{% macro translationField(collection, field = 'label', safe = false) %}
  {% set translation = (collection|default([]))|first %}
  {% set value = translation ? attribute(translation, field) : '' %}
  {% if safe %}
    {{ value|raw }}
  {% else %}
    {{ value }}
  {% endif %}
{% endmacro %}

{% macro linkPath(url) %}
  {% if not url %}
    {{ '' }}
  {% else %}
    {% set trimmed = url|replace({'https://': '', 'http://': '', 'ftp://': ''}) %}
    {% set cleaned = trimmed|split('?')[0]|split('#')[0] %}
    {% set segments = cleaned|split('/') %}
    {% set pathSegments = segments|slice(1) %}
    {% if pathSegments %}
      {{ '/' ~ pathSegments|join('/') }}
    {% endif %}
  {% endif %}
{% endmacro %}

<!DOCTYPE html>
<html lang="{{ 'ko' }}">
  <head>
    <meta charset="UTF-8" />
    <title>{{ cv.firstname }} {{ cv.lastname }}</title>
    <style>
      :root {
        font-family: "Noto Sans CJK KR", "Noto Sans KR", sans-serif;
        color: #1c1c1c;
      }

      body {
        margin: 0;
        padding: 24px 40px 40px;
        line-height: 1.5;
      }

      h1 {
        font-size: 2rem;
        margin: 0;
      }

      h2 {
        margin-top: 32px;
        margin-bottom: 12px;
        text-transform: uppercase;
        font-size: 0.95rem;
        letter-spacing: 0.25em;
      }

      p {
        margin: 4px 0;
      }

      .header {
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 16px;
        border-bottom: 2px solid #e2e2e2;
        padding-bottom: 16px;
      }

      .header-info {
        max-width: 60%;
      }

      .header-meta {
        align-content: center;
        min-width: 200px;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }

      a {
        color: #1b4f9d;
        text-decoration: none;
      }

      .section {
        margin-top: 24px;
      }

      .section article {
        margin-bottom: 16px;
      }

      .tag-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 8px;
      }

      .tag-list span {
        padding: 2px 8px;
        border-radius: 999px;
        background: #f6f6f6;
        font-size: 0.85rem;
      }

      ul {
        padding-left: 1.2rem;
        margin: 8px 0;
      }

      .meta-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 8px;
        margin-top: 8px;
        font-size: 0.85rem;
      }

      .meta-grid p {
        margin: 0;
      }
    </style>
  </head>
  <body>
    {% set collections = collections|default({}) %}
    {% set experiences = collections.experience|default([]) %}
    {% set educations = collections.education|default([]) %}
    {% set projects = collections.project|default([]) %}
    {% set technologies = collections.technology|default([]) %}
    {% set skills = collections.skill|default([]) %}
    {% set languages = collections.language|default([]) %}
    {% set workTypes = collections.workType|default([]) %}
    {% set links = collections.link|default([]) %}
    {% set visaCountries = collections.visaAvailableFor|default([]) %}
    {% set expectedCountries = collections.expectedCountry|default([]) %}

    <header class="header">
      <div class="header-info">
        <h1>{{ cv.firstname }} {{ cv.lastname }}</h1>
        <p>Full Stack Developer | Back End Developer</p>
        {% set locationLabel = _self.translationField(cv.location ? cv.location.i18n : []) %}
        <p>{{ cv.city }}{% if locationLabel %}, {{ locationLabel }}{% endif %}</p>
        <p>
          {% if cv.isFreelance %}Full-time | Freelance{% else %}Full-time{% endif %}
          — {% if cv.isAvailable %}Available{% else %}Not available{% endif %}
        </p>
        {% if visaCountries or expectedCountries %}
        <section class="section">
          {% if visaCountries %}
            {% set visaLabels = [] %}
            {% for country in visaCountries %}
              {% set label = _self.translationField(country.i18n)|trim %}
              {% if label %}
                {% set visaLabels = visaLabels|merge([label]) %}
              {% endif %}
            {% endfor %}
            {% if visaLabels %}
              <p>Visa available for: {{ visaLabels|join(', ') }}</p>
            {% endif %}
          {% endif %}
          {% if expectedCountries %}
            {% set expectedLabels = [] %}
            {% for country in expectedCountries %}
              {% set label = _self.translationField(country.i18n)|trim %}
              {% if label %}
                {% set expectedLabels = expectedLabels|merge([label]) %}
              {% endif %}
            {% endfor %}
            {% if expectedLabels %}
              <p>Willing to work from: {{ expectedLabels|join(', ') }}</p>
              <p>{% if not visaCountries %}Non-EU Visa - required{% endif %}</p>
            {% endif %}
          {% endif %}
        </section>
      {% endif %}

      </div>
      
      <div class="header-meta">
        <p>contact@maengdok.fr</p>
        <div class="links">
          {% for link in links %}
            {% set label = _self.translationField(link.i18n) %}
            <p>
              <a href="{{ link.url }}" target="_blank">{{ label }}</a>
              {% set path = _self.linkPath(link.url) %}
              {% if path %}| {{ path }}{% endif %}
            </p>
          {% endfor %}
        </div>
        {% if workTypes %}
          {% set workTypeLabels = [] %}
          {% for workType in workTypes %}
            {% set label = _self.translationField(workType.i18n) %}
            {% if label %}
              {% set workTypeLabels = workTypeLabels|merge([label]) %}
            {% endif %}
          {% endfor %}
          {% if workTypeLabels %}
            <div class="meta-grid">
              <p>{{ workTypeLabels|join(' / ') }}</p>
            </div>
          {% endif %}
        {% endif %}
      </div>
    </header>

    <section class="section">
      <h2>Experience</h2>
      {% for exp in experiences %}
        <article>
          <p><strong>{{ _self.translationField(exp.i18n) }}</strong></p>
          <p>
            {% if exp.company and exp.company.url %}
              <a href="{{ exp.company.url }}" target="_blank">
              @{{ exp.company.label}}
              </a>
            {% else %}
              @{{ exp.company.label}}
            {% endif %}
            | {{ exp.startingDate ? exp.startingDate|date('Y-m') : '' }}
             — {{ exp.endingDate ? exp.endingDate|date('Y-m') : 'Présent' }}
          </p>
          {% set description = _self.translationField(exp.i18n, 'description', true) %}
          {% if description %}
            <div>{{ description }}</div>
          {% endif %}
          <div class="tag-list">
            {% for tech in exp.technology %}
              <span>{{ tech.label }}</span>
            {% endfor %}
            {% for skill in exp.skill %}
              <span>{{ _self.translationField(skill.i18n) }}</span>
            {% endfor %}
          </div>
        </article>
      {% else %}
        <p>No experience listed.</p>
      {% endfor %}
    </section>

    <section class="section">
      <h2>Education</h2>
      {% for education in educations %}
        <article>
          <p><strong>{{ _self.translationField(education.i18n) }}</strong></p>
          <p>
            {% if education.school and education.school.url %}
              <a href="{{ education.school.url }}" target="_blank">
              @{{ education.school.label}}
              </a>
            {% else %}
              @{{ education.school.label}}
            {% endif %}
            | {{ education.startingDate ? education.startingDate|date('Y-m') : '' }}
             — {{ education.endingDate ? education.endingDate|date('Y-m') : 'Présent' }}
          </p>
          {% set eduDescription = _self.translationField(education.i18n, 'description', true) %}
          {% if eduDescription %}
            <div>{{ eduDescription|raw }}</div>
          {% endif %}
        </article>
      {% else %}
        <p>No education recorded.</p>
      {% endfor %}
    </section>

    <section class="section">
      <h2>Projects</h2>
      {% for project in projects %}
        <article>
          <p><strong>{{ _self.translationField(project.i18n) }}</strong></p>
          <p>
            <strong>
              {% if project.company and not project.school %}
                {% if project.company.url %}
                  <a href="{{ project.company.url }}" target="_blank">
                  @{{ project.company.label}}
                  </a>
                {% else %}
                  @{{ project.company.label}}
                {% endif %}
              {% endif %}

              {% if not project.company and project.school %}
                {% if project.school.url %}
                  <a href="{{ project.school.url }}" target="_blank">
                  @{{ project.school.label}}
                  </a>
                {% else %}
                  @{{ project.school.label}}
                {% endif %}
              {% endif %}
            </strong>
          </p>
          {% set projectDescription = _self.translationField(project.i18n, 'cvDescription', true) %}
          {% if projectDescription %}
            <div>{{ projectDescription }}</div>
          {% endif %}
          <div class="tag-list">
            {% for tech in project.technology %}
              <span>{{ tech.label }}</span>
            {% endfor %}
          </div>
        </article>
      {% else %}
        <p>No projects to display.</p>
      {% endfor %}
    </section>

    <section class="section">
      <h2>Technologies & skills</h2>
      <div class="tag-list">
        {% for tech in technologies %}
          <span>{{ tech.label }}</span>
        {% endfor %}
        {% for skill in skills %}
          <span>{{ _self.translationField(skill.i18n) }}</span>
        {% endfor %}
      </div>
    </section>

    <section class="section">
      <h2>Languages</h2>
      <ul>
        {% for language in languages %}
          <li>
            {{ _self.translationField(language.i18n, 'label') ?: _self.translationField(language.i18n) }}
            {% if _self.translationField(language.i18n, 'level') %}
              — {{ _self.translationField(language.i18n, 'level') }}
            {% endif %}
          </li>
        {% else %}
          <li>No languages listed.</li>
        {% endfor %}
      </ul>
    </section>
  </body>
</html>
